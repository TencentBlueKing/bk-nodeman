# 节点管理 Agent 2.0 灰度逻辑

## 基本思想

> 基于「接入点」的灰度逻辑


「接入点」是节点管理对 GSE 环境的抽象，对于 GSE 2.0，节点管理基于原有的 GSE 1.0 接入点，新建 2.0 接入点用于对接 GSE 2.0 的环境。

灰度切换：配合运维同学提供的迁移脚本，渐进式地将主机切换到 2.0 接入点

## 直连区域

### 当前业务已全面灰度

* 增量主机：**安装 2.0 Agent**
    * 通过节点管理进行 Agent 操作的主机，如果**仍选择 1.0 的接入点**，会通过预设的映射关系重定向到 2.0，从而兼容原来的
      API / 操作行为
* 存量主机：如果没有安装 2.0 Agent，「Agent 状态」页面会展示异常，可以操作重装，行为与「增量主机」一致

### 当前业务部分主机灰度

* 增量主机：
    * 安装/重载配置时选择 1.0 接入点「推荐，也是默认行为」：**安装 1.0 Agent**
    * 安装/重载配置时选择 2.0 接入点：安装 2.0 Agent，该操作等同于将这台主机设置为灰度

* 存量主机：
    * 灰度主机：「Agent 状态」页面可以看到版本属于 2.0 系列版本，在节点管理上操作时，默认行为是**安装 2.0 Agent**
    * 其他主机：默认行为是**安装 1.0 Agent**

⚠️ 当业务处于部分主机灰度状态时，应避免在安装/重装 Agent 时变更主机接入点，避免对接到预期外的 GSE 环境

## 云区域

### 当前云区域已全面灰度

> 云区域所属接入点已调整为 2.0 接入点

#### 云区域全面灰度条件

* 同步业务灰度：当云区域**覆盖的所有业务**已进入全面灰度时，云区域自动进入全面灰度
* 主动进入灰度：在节点管理云区域页面，调整所属接入点至 2.0 接入点

增量主机/存量主机行为同「当前业务已全部灰度」

### 当前云区域部分灰度

> 云区域所属接入点仍为 1.0 接入点

#### 前置条件：Proxy 进入灰度

* 通过标准运维节点管理官方插件等方式安装/重装若干 2.0 Proxy
* 通过运维手段进行进程相关数据的迁移
* 安装 P-Agent 时，节点管理会**基于 P-Agent 所对接的 GSE 环境版本，选择同环境版本的 Proxy 作为上游**（Proxy
  可能是共存或者单版本，不能盲选这个云区域下全部的 Proxy 作为上游）
* 如果该云区域在灰度过程中期望 1.0 / 2.0 P-Agent 都可新增安装，那么通过运维手段切换时，Proxy 只能切一部分，等到要完全灰度时，再全部切换

⚠️ 部分灰度说明该云区域处在运维手段切换期间，所以 Proxy / P-Agent 不支持通过节点管理页面选择 2.0 接入点安装为 2.0 Agent /
Proxy。（API 层面不做限制，为运维手段切换提供安装等能力）
