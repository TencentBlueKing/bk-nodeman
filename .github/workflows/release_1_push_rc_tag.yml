# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Push rc tag

on:
  push:
    branches:
      - "v[0-9]+.[0-9]+.x"

jobs:
  build:
    # æ›´æ–°æ¬¡ç‰ˆæœ¬å·ï¼Œé¿å… push åè¯¯æ‰§è¡Œ
    if: ${{ false }}
    runs-on: ubuntu-latest
    env:
      # æ„å»ºç¯å¢ƒçš„Pythonç‰ˆæœ¬
      PYTHON_VERSION: "3.7"
      # yamlä¸­ç‰ˆæœ¬çš„æè¿°è·¯å¾„
      VERSION_KW_P: "version"
      # æè¿°appçš„yamlæ–‡ä»¶
      APP_DESC_YAML: "app.yml"
      # tag åç§°å‰ç¼€
      TAG_NAME_PREFIX: "v"
      # ä¸´æ—¶Tagåç§°åç¼€
      TEMP_TAG_NAME_SUFFIX: "-alpha"

    steps:
    - id: checkout
      name: Checkout
      uses: actions/checkout@v2

    - id: set-up-python
      name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - id: install-requirements
      name: Install requirements
      run: |
        pip install PyYAML
        pip install packaging
        pip install ruamel.yaml
    - id: set-env
      name: Set env
      run: |
        # ä»yamlæ–‡ä»¶ä¸­è·å–å¾…å‘å¸ƒç‰ˆæœ¬å·
        prerelease_version=$( python scripts/workflows/release/op_yaml.py -f ${{ env.APP_DESC_YAML }} --keyword-path ${{ env.VERSION_KW_P }} --op get )
        echo "ğŸš€ prerelease_version -> $prerelease_version"
        # é¢„å‘å¸ƒç‰ˆæœ¬å·
        echo "PRERELEASE_VERSION=$prerelease_version" >> $GITHUB_ENV
        # ä¸´æ—¶tagåç§°
        echo "TEMPORARY_TAG_NAME=${{ env.TAG_NAME_PREFIX }}$prerelease_version${{ env.TEMP_TAG_NAME_SUFFIX }}" >> $GITHUB_ENV
    - id: create-temporary-tag
      name: Create temporary tag
      uses: actions/github-script@v5
      with:
        github-token: ${{ secrets.TOKEN_FOR_TENCENT }}
        script: |
          github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'refs/tags/${{ env.TEMPORARY_TAG_NAME }}',
            sha: context.sha
          })
    - id: celebrate
      name: Celebrate
      run: |
        echo "ğŸ‰ Worth celebrating"
        echo "ğŸ» All steps are successfully completed"
        echo "ğŸ‘‹ Goodbye!"
