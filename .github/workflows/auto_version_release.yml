# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Release version

on:
  push:
    branches:
      - V[0-9]+.[0-9]+.X

jobs:
  build:
    runs-on: ubuntu-latest
    # éç¨³å®šå¼€å‘åˆ†æ”¯ï¼Œæš‚æ—¶ç¦ç”¨è‡ªåŠ¨å‘å¸ƒworkflow
    if: ${{ false }}
    env:
      # æ„å»ºç¯å¢ƒçš„Pythonç‰ˆæœ¬
      PYTHON_VERSION: "3.7"
      # yamlä¸­ç‰ˆæœ¬çš„æè¿°è·¯å¾„
      VERSION_KW_P: "version"
      # æè¿°appçš„yamlæ–‡ä»¶
      APP_YAML: "app.yml"
      # github æäº¤ç”¨æˆ·å
      GITHUB_USERNAME: "github-actions"
      # å¼€å‘æ—¥å¿—æ‰€åœ¨ç›®å½•
      DEV_LOG_ROOT: "dev_log"
      # å‘å¸ƒæ—¥å¿—æ‰€åœ¨ç›®å½•
      RELEASE_LOG_ROOT: "release"
      RELEASE_MD_PATH: "docs/release.md"
      # tag åç§°å‰ç¼€
      TAG_NAME_PREFIX: "V"
      # release åç§°å‰ç¼€
      RELEASE_NAME_PREFIX: "V"
      # å¼€å‘åˆ†æ”¯åç§°åç¼€
      DEV_BRANCH_SUFFIX: "-rc"
      # å¼€å‘åˆ†æ”¯åç§°å‰ç¼€
      DEV_BRANCH_PREFIX: "V"

    steps:
    - id: checkout
      name: Checkout
      uses: actions/checkout@v2

    - id: set-up-python
      name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - id: install-requirements
      name: Install requirements
      run: |
        pip install PyYAML
        pip install packaging
        pip install ruamel.yaml

    - id: generate-dev-log
      name: Generate dev log
      run: |
        # è·å–é¢„å‘å¸ƒç‰ˆæœ¬
        prerelease_version=$( python scripts/workflows/release/op_yaml.py -f ${{ env.APP_YAML }} --keyword-path ${{ env.VERSION_KW_P }} --op get )
        echo "ğŸš€ prerelease_version -> $prerelease_version"

        # è·å–å‘å¸ƒæ—¥å¿—è·¯å¾„å¹¶æ›´æ–°å‘å¸ƒæ—¥å¿—
        release_log_path=$( python scripts/workflows/release/upgrade_release_log.py -d ${{ env.DEV_LOG_ROOT }} -r ${{ env.RELEASE_LOG_ROOT }} -p ${{ env.RELEASE_MD_PATH }} -v $prerelease_version )
        echo "ğŸŒŸ release_log_path -> $release_log_path"
        release_log=$( cat "$release_log_path" )
        echo "ğŸ“’ release_log -> ğŸ‘‡ğŸ‘‡ğŸ‘‡ $release_log"

        # è·å–å‘å¸ƒæ—¥å¿—è·¯å¾„
        release_log_path=$( echo ${{ env.RELEASE_LOG_ROOT }}/$(ls -a ${{ env.RELEASE_LOG_ROOT }} | grep "$prerelease_version"_) )

        # æ¨é€å‘å¸ƒæ—¥å¿—
        git config --global user.email "${{ env.GITHUB_USERNAME }}@users.noreply.github.com"
        git config --global user.name "${{ env.GITHUB_USERNAME }}"
        git add .
        git commit -m "docs: auto generate $prerelease_version release log"
        git push origin ${{ github.ref }}
        echo "âœ¨ï¸ main branch -> ${{ github.ref }} has been updated"

        # è®¾ç½®è¾“å‡º
        echo "::set-output name=release_log_path::$(echo $release_log_path)"
        echo "::set-output name=prerelease_version::$(echo $prerelease_version)"

    - id: create-tag
      name: Create tag
      run: |
        # ä»ä¸Šä¸ªæ­¥éª¤è·å–é¢„å‘å¸ƒç‰ˆæœ¬å·ï¼Œæ‹¼æ¥ä¸ºæ ‡ç­¾åç§°
        tag_name=$( echo "${{ env.TAG_NAME_PREFIX }}${{ steps.generate-dev-log.outputs.prerelease_version }}" )
        release_log=$( cat ${{ steps.generate-dev-log.outputs.release_log_path }} )
        echo "ğŸ·ï¸ tag -> $tag_name will be created"

        # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        # --cleanup=verbatim ä¿®æ”¹é»˜è®¤çš„æ³¨é‡Šæ¸…ç†æ¨¡å¼ï¼Œä¿æŒå®Œæ•´çš„æäº¤ä¿¡æ¯ï¼Œé»˜è®¤çš„æ¨¡å¼ä¼šå°† # å¼€å¤´çš„ä¿¡æ¯è§†ä¸ºæ³¨é‡Šè¡Œ
        # å‚è€ƒï¼šhttps://stackoverflow.com/questions/2788092/start-a-git-commit-message-with-a-hashmark
        # å‚è€ƒï¼šhttps://git.kernel.org/pub/scm/git/git.git/plain/Documentation/git-commit.txt
        git tag -a "$tag_name" -m "$release_log" --cleanup=verbatim
        git push origin "$tag_name"
        echo "âœ¨ï¸ tag -> $tag_name has been created"

        # è¾“å‡º tag_name
        echo "::set-output name=tag_name::$(echo $tag_name)"

    - id: create-release
      name: Create release
      uses: actions/create-release@latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.create-tag.outputs.tag_name }}
        release_name: ${{ env.RELEASE_NAME_PREFIX }}${{ steps.generate-dev-log.outputs.prerelease_version }}
        body_path: ${{ steps.generate-dev-log.outputs.release_log_path }}
        draft: false
        prerelease: true

    - id: start-new-version
      name: Start new version
      run: |

        # ç‰ˆæœ¬å·²å‘å¸ƒï¼Œæ­¤æ—¶å–å‡ºçš„é¢„å‘å¸ƒç‰ˆæœ¬æ˜¯æœ€æ–°ç‰ˆæœ¬
        latest_version=$( echo "${{ steps.generate-dev-log.outputs.prerelease_version }}" )
        echo "ğŸ”¥ï¸ latest_version -> $latest_version"

        next_version=$( python scripts/workflows/release/version_increment.py --version "$latest_version" )
        echo "â¬‡ï¸ next_version -> $next_version"

        # æ£€å‡ºæ–°å¼€å‘åˆ†æ”¯
        dev_branch_name=$( echo "${{ env.DEV_BRANCH_PREFIX }}${next_version}${{ env.DEV_BRANCH_SUFFIX }}" )
        echo "ğŸŒ¿ dev_branch_name -> $dev_branch_name"
        git checkout -b "$dev_branch_name"

        # å¼€å‘åˆ†æ”¯å†™å…¥é¢„å‘å¸ƒç‰ˆæœ¬å·
        python scripts/workflows/release/op_yaml.py -f ${{ env.APP_YAML }} --keyword-path ${{ env.VERSION_KW_P }} --op set --value "$next_version"

        # åˆ›å»ºæ–°å¼€å‘ç‰ˆæœ¬çš„å¼€å‘æ—¥å¿—ç›®å½•
        next_version_dev_log_dir_path=$(echo "${{ env.DEV_LOG_ROOT }}/$next_version" )
        echo "ğŸ“– next_version_dev_log_dir_path -> $next_version_dev_log_dir_path"
        mkdir -p "$next_version_dev_log_dir_path"
        touch "$next_version_dev_log_dir_path/.gitkeep"

        # æ¨é€åˆ°ä»“åº“
        git add .
        git commit -m "minor: start new version $next_version"
        git push origin "$dev_branch_name"
        echo "âœ¨ï¸ dev_branch -> $dev_branch_name has been created"

    - id: celebrate
      name: Celebrate
      run: |
        echo "ğŸ‰ Worth celebrating"
        echo "ğŸ» All steps are successfully completed"
        echo "ğŸ‘‹ Goodbye!"
