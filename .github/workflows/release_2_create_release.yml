# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Create release

on:
  push:
    tags:
      # ä»…ç›‘å¬é¢„å‘å¸ƒtagçš„åˆ›å»º
      - "v[0-9]+.[0-9]+.[0-9]+-*"

jobs:
  build:
    runs-on: ubuntu-20.04
    env:
      # æ„å»ºç¯å¢ƒçš„Pythonç‰ˆæœ¬
      PYTHON_VERSION: "3.7"
      # yamlä¸­ç‰ˆæœ¬çš„æè¿°è·¯å¾„
      VERSION_KW_P: "version"
      # æè¿°appçš„yamlæ–‡ä»¶
      APP_DESC_YAML: "app.yml"
      # å‘å¸ƒæ—¥å¿—æ‰€åœ¨ç›®å½•
      RELEASE_LOG_ROOT: "release"
      # å‘å¸ƒæ—¥å¿—READMEæ–‡æ¡£æ‰€åœ¨æ–‡ä»¶
      RELEASE_MD_PATH: "docs/release.md"
      # tag åç§°å‰ç¼€
      TAG_NAME_PREFIX: "v"
      # ä¸´æ—¶Tagåç§°åç¼€
      TEMP_TAG_NAME_SUFFIX: "-alpha"
      # å¼€å‘åˆ†æ”¯åç§°åç¼€
      DEV_BRANCH_SUFFIX: "-dev"

    steps:
    - id: checkout
      name: Checkout
      uses: actions/checkout@v2

    - id: set-up-python
      name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - id: install-requirements
      name: Install requirements
      run: |
        pip install PyYAML
        pip install packaging
        pip install ruamel.yaml
    - id: set-env
      name: Set env
      run: |
        git config --global user.email "${{ secrets.GIT_EMAIL }}"
        git config --global user.name "${{ secrets.GIT_NAME }}"
        git fetch --all
        # github å…¬å…±å˜é‡
        # Github repo url
        echo "GITHUB_REPO_URL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" >> $GITHUB_ENV
        # ä¸»åˆ†æ”¯
        echo "DEFAULT_BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
        # ä»yamlæ–‡ä»¶ä¸­è·å–å¾…å‘å¸ƒç‰ˆæœ¬å·
        prerelease_version=$( python scripts/workflows/release/op_yaml.py -f ${{ env.APP_DESC_YAML }} --keyword-path ${{ env.VERSION_KW_P }} --op get )
        # ä¸´æ—¶tagåç§°
        echo "TEMPORARY_TAG_NAME=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
        # é¢„å‘å¸ƒç‰ˆæœ¬å·
        echo "PRERELEASE_VERSION=$prerelease_version" >> $GITHUB_ENV
        # é¢„å‘å¸ƒTagåç§°
        echo "TAG_NAME=${{ env.TAG_NAME_PREFIX }}$prerelease_version" >> $GITHUB_ENV
    - id: validated-version
      name: Validated version
      run: |
        if [[ "${{ env.TEMPORARY_TAG_NAME }}" == "${{ env.TAG_NAME }}${{ env.TEMP_TAG_NAME_SUFFIX }}" ]]
        then
          exit 0
        else
          echo "âš ï¸ ${{ env.TEMPORARY_TAG_NAME }} != ${{ env.TAG_NAME }}${{ env.TEMP_TAG_NAME_SUFFIX }}"
          exit 1
        fi
    - id: build-release-log
      name: Build release log
      uses: mikepenz/release-changelog-builder-action@v3.5.0
      with:
        # å‚è€ƒï¼šhttps://github.com/mikepenz/release-changelog-builder-action
        configuration: ".github/configuration.json"
        commitMode: true
        ignorePreReleases: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - id: delete-temporary-tag
      name: Delete temporary tag
      uses: actions/github-script@v5
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        # å‚è€ƒ https://octokit.github.io/rest.js/v18#git-delete-ref
        # å‚è€ƒ https://github.com/actions/github-script
        script: |
          github.rest.git.deleteRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'tags/${{ env.TEMPORARY_TAG_NAME }}'
          })
    - id: push-release-log
      name: Push release log
      run: |
        # è·å–å‘å¸ƒæ—¥å¿—è·¯å¾„å¹¶æ›´æ–°å‘å¸ƒæ—¥å¿—
        echo "${{ steps.build-release-log.outputs.changelog }}" >> /tmp/log.md
        # mikepenz/release-changelog-builder-action æ— æ³•ä½¿ç”¨è¾“å‡ºå˜é‡ steps.build-release-log.outputs.fromTagï¼Œæš‚æ—¶é‡‡ç”¨æ¨¡æ¿æ¸²æŸ“çš„æ–¹å¼
        sed -i "s|__TO_TAG___|${{ env.TAG_NAME }}|g" /tmp/log.md
        sed -i "s|__GITHUB_REPO_URL__|${{ env.GITHUB_REPO_URL }}|g" /tmp/log.md
        release_log_path=$( python scripts/workflows/release/upgrade_release_log.py -r ${{ env.RELEASE_LOG_ROOT }} -v ${{ env.PRERELEASE_VERSION }} -p ${{ env.RELEASE_MD_PATH }} -l /tmp/log.md )
        
        # è¾“å‡ºreleaseæ—¥å¿—è·¯å¾„åŠå†…å®¹
        echo "ğŸŒŸ release_log_path -> $release_log_path"
        echo "ğŸ“’ release_log -> ğŸ‘‡ğŸ‘‡ğŸ‘‡ $( cat "$release_log_path" )"
        # åˆ‡æ¢åˆ°é»˜è®¤åˆ†æ”¯
        git checkout ${{ env.DEFAULT_BRANCH }}
        # æ¨é€å‘å¸ƒæ—¥å¿—
        git add .
        git commit -m "minor: auto push ${{ env.PRERELEASE_VERSION }} release log"
        git push origin ${{ env.DEFAULT_BRANCH }}
        echo "âœ¨ï¸ default branch -> ${{ env.DEFAULT_BRANCH }} has been updated"
        # è®¾ç½®è¾“å‡º
        echo "::set-output name=release_log_path::$(echo $release_log_path)"
    - id: create-tag
      name: Create tag
      run: |
        echo "ğŸ·ï¸ tag -> ${{ env.TAG_NAME }} will be created"
        release_log=$( cat ${{ steps.push-release-log.outputs.release_log_path }} )
        # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        # --cleanup=verbatim ä¿®æ”¹é»˜è®¤çš„æ³¨é‡Šæ¸…ç†æ¨¡å¼ï¼Œä¿æŒå®Œæ•´çš„æäº¤ä¿¡æ¯ï¼Œé»˜è®¤çš„æ¨¡å¼ä¼šå°† # å¼€å¤´çš„ä¿¡æ¯è§†ä¸ºæ³¨é‡Šè¡Œ
        # å‚è€ƒï¼šhttps://stackoverflow.com/questions/2788092/start-a-git-commit-message-with-a-hashmark
        # å‚è€ƒï¼šhttps://git.kernel.org/pub/scm/git/git.git/plain/Documentation/git-commit.txt
        git tag -a "${{ env.TAG_NAME }}" -m "$release_log" --cleanup=verbatim
        git push origin "${{ env.TAG_NAME }}"
        echo "âœ¨ï¸ tag -> ${{ env.TAG_NAME }} has been created"
    - id: start-new-version
      name: Start new version
      run: |
        # è·å–ä¸‹ä¸€ä¸ªç‰ˆæœ¬
        next_version=$( python scripts/workflows/release/version_increment.py --version ${{ env.PRERELEASE_VERSION }} )
        echo "â¬‡ï¸ next_version -> $next_version"
        # æ£€å‡ºæ–°å¼€å‘åˆ†æ”¯
        dev_branch_name=$( echo "${{ env.TAG_NAME_PREFIX }}${next_version}${{ env.DEV_BRANCH_SUFFIX }}" )
        echo "ğŸŒ¿ dev_branch_name -> $dev_branch_name"
        git checkout -b "$dev_branch_name"
        # å¼€å‘åˆ†æ”¯å†™å…¥é¢„å‘å¸ƒç‰ˆæœ¬å·
        python scripts/workflows/release/op_yaml.py -f ${{ env.APP_DESC_YAML }} --keyword-path ${{ env.VERSION_KW_P }} --op set --value "$next_version"
        # æ¨é€åˆ°ä»“åº“
        git add . && git commit -m "minor: start new version $next_version" && git push origin "$dev_branch_name"
        echo "âœ¨ï¸ dev_branch -> $dev_branch_name has been created"
    - id: create-release
      name: Create release
      uses: actions/create-release@latest
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_FOR_TENCENT }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        release_name: ${{ env.TAG_NAME }}
        body_path: ${{ steps.push-release-log.outputs.release_log_path }}
        draft: false
        prerelease: true

    - id: celebrate
      name: Celebrate
      run: |
        echo "ğŸ‰ Worth celebrating"
        echo "ğŸ» All steps are successfully completed"
        echo "ğŸ‘‹ Goodbye!"
